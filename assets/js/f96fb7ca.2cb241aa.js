"use strict";(self.webpackChunkmaatth_github_io=self.webpackChunkmaatth_github_io||[]).push([[1152],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>m});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(a),p=i,m=u["".concat(l,".").concat(p)]||u[p]||h[p]||o;return a?n.createElement(m,r(r({ref:t},d),{},{components:a})):n.createElement(m,r({ref:t},d))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:i,r[1]=s;for(var c=2;c<o;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},8083:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var n=a(7462),i=(a(7294),a(3905));const o={sidebar_position:1},r="PostgreSQL isolation transaction",s={unversionedId:"databases/typescript-integration-study",id:"databases/typescript-integration-study",title:"PostgreSQL isolation transaction",description:"This article illustrates some behaviours of the various transaction isolation settings described in the official PostgreSQL documentation//www.postgresql.org/docs/12/transaction-iso.html. It is recommended to read it first.",source:"@site/docs/databases/typescript-integration-study.md",sourceDirName:"databases",slug:"/databases/typescript-integration-study",permalink:"/docs/databases/typescript-integration-study",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/databases/typescript-integration-study.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Databases",permalink:"/docs/category/databases"},next:{title:"DevOps",permalink:"/docs/category/devops"}},l={},c=[{value:"Reminders",id:"reminders",level:2},{value:"Read Uncommitted",id:"read-uncommitted",level:2},{value:"Read Committed",id:"read-committed",level:2},{value:"Repeatable Read",id:"repeatable-read",level:2},{value:"Serializable",id:"serializable",level:2}],d={toc:c},u="wrapper";function h(e){let{components:t,...o}=e;return(0,i.kt)(u,(0,n.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"postgresql-isolation-transaction"},"PostgreSQL isolation transaction"),(0,i.kt)("p",null,"This article illustrates some behaviours of the various transaction isolation settings described in the official PostgreSQL documentation: ",(0,i.kt)("a",{parentName:"p",href:"https://www.postgresql.org/docs/12/transaction-iso.html"},"https://www.postgresql.org/docs/12/transaction-iso.html"),". It is recommended to read it first."),(0,i.kt)("h2",{id:"reminders"},"Reminders"),(0,i.kt)("p",null,"This section contains quick reminders from the PostgreSQL documentation."),(0,i.kt)("p",null,"A transaction begins with the BEGIN command and is validated by the COMMIT command. Each SQL query is automatically encapsulated in a transaction by PostgreSQL."),(0,i.kt)("p",null,"The SQL standard describes 4 problems (phenomena) to avoid when executing a transaction:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"dirty read"),': occur when one transaction reads data written by another, uncommitted, transaction. The danger with dirty reads is that the other transaction might never commit, leaving the original transaction with "dirty" data.'),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"nonrepeatable read"),": A transaction re-reads data (during the same transaction) it has previously read and finds that data has been modified by another transaction (that committed since the initial read)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"phantom read"),": A transaction re-executes a query returning a set of rows that satisfy a search condition and finds that the set of rows satisfying the condition has changed due to another recently-committed transaction"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"serialization anomaly"),": The result of successfully committing a group of transactions is inconsistent with all possible orderings of running those transactions one at a time")),(0,i.kt)("p",null,"The SQL standard describes 4 transaction isolation modes that will be used to progressively prevent its phenomena (in order of tolerance to the phenomena):"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Read Uncommitted"),(0,i.kt)("li",{parentName:"ol"},"Read committed"),(0,i.kt)("li",{parentName:"ol"},"Repeatable Read"),(0,i.kt)("li",{parentName:"ol"},"Serializable")),(0,i.kt)("h2",{id:"read-uncommitted"},"Read Uncommitted"),(0,i.kt)("p",null,'It is the weakest isolation level because it can read the data which are acquired exclusive lock to the resources by the other transactions (unlike "read committed") So, it might help to avoid locks and deadlock problems for the data reading operations. It can be used to debug inside a transaction. In PostgreSQL, this isolation mode behaves like "Read Committed".'),(0,i.kt)("h2",{id:"read-committed"},"Read Committed"),(0,i.kt)("p",null,"This is the default transaction isolation."),(0,i.kt)("p",null,"In this mode, each request sees all already validated data (before the beginning of the transaction). In the following example, we simulate the concurrent access of two transactions by the use of two consoles in which the commands are executed. So the SELECT query in console 2 (",(0,i.kt)("font",{color:"#FF4500"},"(1)"),"  below) sees 123 (and not 124) because the UPDATE in console 1 has not yet been committed in the other transactions (because COMMIT is executed after SELECT):"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"1",src:a(641).Z,width:"1233",height:"327"})),(0,i.kt)("p",null,"The two consoles in which the commands are executed simulate the concurrent access of two transactions."),(0,i.kt)("p",null,"Thus, in the same transaction, if a second SELECT is executed after the validation of the transaction from console 1, it will see 124. See ",(0,i.kt)("font",{color:"#FF4500"},"(2)")," below. This\nbehaviour is called ",(0,i.kt)("strong",{parentName:"p"},'"nonrepeatable read"')," and is one of the 4 phenomena that we try to avoid."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"2",src:a(3759).Z,width:"1236",height:"350"})),(0,i.kt)("p",null,"This SELECT (",(0,i.kt)("font",{color:"#FF4500"},"(3)")," below) can see the result of previous query that are in the same transaction (even though they are not committed). Example, the SELECT (",(0,i.kt)("font",{color:"#FF4500"},"(3)")," below) will return 151."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"3",src:a(5825).Z,width:"1223",height:"303"})),(0,i.kt)("p",null,"For the UPDATE, DELETE commands, this behaviour is a little bit different since if the line they update is also modified by another transaction, these commands will wait for the end of this other transaction (either the cancellation or the validation), then use its result. In the example below, the UPDATE of console 2 ",(0,i.kt)("font",{color:"#FF4500"},"(4)")," will see 124 (result of the transaction on the left after the commit) and will return 125."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"4",src:a(1720).Z,width:"1239",height:"326"})),(0,i.kt)("p",null,"The same behaviour as UPDATE and DELETE can be obtained with SELECT by adding the FOR UPDATE or FOR SHARE clause. For example:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"SELECT balance FROM account WHERE account_num = 9 FOR UDPATE;")," "),(0,i.kt)("p",null,"will wait for other transactions that concern this row to finish."),(0,i.kt)("p",null,"When UPDATE is executed (after the wait), its WHERE clause is re-evaluated to make sure it's the same row that it is modifying. If the row no longer matches the WHERE clause, the UPDATE is canceled."),(0,i.kt)("p",null,"This re-evaluation then cancellation can also cause unexpected behaviour: the phenomenon of ",(0,i.kt)("strong",{parentName:"p"},'"phantom read"'),". For example the following DELETE will not delete any line:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"5",src:a(7201).Z,width:"1228",height:"307"})),(0,i.kt)("p",null,"Because, after the transaction in console 1 updates all the lines, the DELETE of console 2 (",(0,i.kt)("font",{color:"#FF4500"},"(5)")," above) will:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"evaluate its WHERE clause (which only concerns the row of id 2),"),(0,i.kt)("li",{parentName:"ul"},"then wait for the first transaction to finish because it modifies this line too."),(0,i.kt)("li",{parentName:"ul"},"reevaluate the WHERE clause only for row of id 2"),(0,i.kt)("li",{parentName:"ul"},"the balance of this line no longer checks the WHERE clause so the DELETE is canceled.")),(0,i.kt)("h2",{id:"repeatable-read"},"Repeatable Read"),(0,i.kt)("p",null,"Unlike the ",(0,i.kt)("strong",{parentName:"p"},'"Read Committed"')," mode, this mode will only see the data validated before the start of the transaction. Thus, the phenomenon of ",(0,i.kt)("strong",{parentName:"p"},'"nonrepeatable read"')," becomes impossible and the SELECT ",(0,i.kt)("font",{color:"#FF4500"},"(6)")," below returns the same result as the previous SELECT."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"6",src:a(48).Z,width:"1232",height:"346"})),(0,i.kt)("p",null,"The behaviour of UPDATE, DELETE, SELECT FOR UPDATE / SHARE will change: instead of waiting for the result of the concurrent transaction (see ",(0,i.kt)("font",{color:"#FF4500"},"(4)"),"), the transaction will be rolled back with the message:\n",(0,i.kt)("em",{parentName:"p"},'"ERROR: could not serialize access due to concurrent update" (see ',(0,i.kt)("font",{color:"#FF4500"},"(7)")," below)")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"7",src:a(5758).Z,width:"1235",height:"313"})),(0,i.kt)("p",null,"So it will be necessary to implement retry mechanisms when this error occurs."),(0,i.kt)("admonition",{title:"To summarise",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},'The differences with "Read Committed" mode are:'),(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},"advantage: avoids the ",(0,i.kt)("strong",{parentName:"li"},'"non repeatable read"')," and ",(0,i.kt)("strong",{parentName:"li"},'"phantom read"')," phenomena."),(0,i.kt)("li",{parentName:"ul"},"drawback: requires the implementation of retry."))),(0,i.kt)("h2",{id:"serializable"},"Serializable"),(0,i.kt)("p",null,'This mode has the same behaviour as "Repeatable Read", but it will also check that the database modifications are identical even if the execution order of the concurrent transactions is changed.'),(0,i.kt)("p",null,"In the following example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the transaction in console 1 sums the values of class 1, then inserts the result with a class 2 ",(0,i.kt)("font",{color:"#FF4500"},"(8)")),(0,i.kt)("li",{parentName:"ul"},"the transaction in console 2 sums the values of class 2, then inserts the result with a class 1")),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"8",src:a(3992).Z,width:"1230",height:"481"})),(0,i.kt)("p",null,"In this case, PostgreSQL will check if the result is the same by first executing the transaction from console 2 before the transaction from console 1."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"9",src:a(2332).Z,width:"1232",height:"482"})),(0,i.kt)("p",null,"Here, the result of the table is not the same after the inversion ",(0,i.kt)("font",{color:"#FF4500"},"(9)"),", so the transaction of console 1 will be committed, but the one of console 2 will be rolled back."),(0,i.kt)("admonition",{title:"To summarise",type:"tip"},(0,i.kt)("p",{parentName:"admonition"},'The differences with "Repeatable Read" mode are:'),(0,i.kt)("ul",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ul"},'advantage: avoids the "serialization anomaly" phenomenon.'),(0,i.kt)("li",{parentName:"ul"},"disadvantage: is more expensive in computation than the two other modes (except if one abuses the explicit locks FOR UPDATE / SHARE)."))),(0,i.kt)("p",null,"TLDR\nimaginez qu'il y a deux transactions (dont un commence avant l'autre). La 1ere fait un update sur une ligne et l'autre lit cette ligne juste apr\xe8s (ou fait aussi un update). Qu'est ce qui se passe ? La valeur lue est-elle celle avant le d\xe9but de la premi\xe8re transaction ou apr\xe8s celle-ci ?\nEt bien, ca d\xe9pend de ce vous choisissez comme mode d'isolation entre transaction. Un peu comme pour d\xe9finir un degr\xe9 d'ind\xe9pendance entre ces deux transactions.\nPour nous aider \xe0 choisir, le standard SQL a d\xe9fini 4 pb que l'on voudra (ou pas) \xe9viter :\ndirty read : (lecture sans se soucier des autres transactions)\nnonrepeatable read : une transaction lit deux fois une ligne mais le second r\xe9sultat diff\xe8re par rapport \xe0 la premi\xe8re lecture.\nphantom read : pareil mais entre temps, la ligne a carr\xe9ment disparue !\nserialization anomaly : le resultat d\xe9pend de l'ordre d'execution des transactions :("),(0,i.kt)("p",null,"Dans sa grande bont\xe9, \xe0 chaque pb est associ\xe9 un mode d'interaction entre transaction appel\xe9 \"mode d'isolation\". C'est-\xe0-dire que chaque mode va empecher un nb croissant de ces pb."),(0,i.kt)("p",null,"Read committed:\nT1 update et T2 select : le select lit uniquement ce qui est valid\xe9 (ne voit pas le update) (sauf si FOR UPDATE)\nT1 update et T2 update (ou delete) : T2 attend la fin de T1 pour recalculer le where. Si ca retourne la meme ligne, T2 continue, sinon l'update est ignor\xe9. (si T1 roll back, alors on prend la valeur d'avant T1)\ndonc regarde la valeur avant T1 (pour les select) et apr\xe8s T2 (pour update et delete), dans tt les cas c'est valid\xe9, donc plus de dirty read\nmais il reste non repeatable read phenomene car la valeur lue avant peut-etre modifi\xe9e par T1"),(0,i.kt)("p",null,"repetable read : pareil qu'au dessus (attente que T1 finisse) pour le select, mais error si T2 update, delete ou select for update "),(0,i.kt)("p",null,"serializable : v\xe9rifie le meme r\xe9sultat si ordre des transaction change (tr\xe8s consommateur de ressources)"))}h.isMDXComponent=!0},641:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/1-13882cb6699c35cc513f1cef88044c6b.png"},3759:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/2-c106ed9d03cd54d9d9972128faa7dbdb.png"},5825:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/3-ba6a32d4cb6009084619a7cca37e0b7c.png"},1720:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/4-50e4a2060fd1869a5513b7396b387787.png"},7201:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/5-1d0b31c7bf96d53e53fcf8e92566e15b.png"},48:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/6-8c36fa2d4856e7c22a5009d707ba024a.png"},5758:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/7-3ab5d7cfd50ff13e4c5561356cdaa5fe.png"},3992:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/8-fdcda32c91c6051e0624752f4710a81b.png"},2332:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/9-2ca1c128136d600d79594ca736f9c6ac.png"}}]);